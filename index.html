<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Graficador con Dominio, Rango y As√≠ntotas</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 30px;
    }
    input, button {
      padding: 10px;
      margin: 10px;
      width: 320px;
    }
    #output {
      margin-top: 20px;
      font-size: 18px;
    }
  </style>
</head>
<body>

  <h2>üìà Graficador de Funciones</h2>
  <p>Escribe una funci√≥n: <code>x^2</code>, <code>1/(x-2)</code>, <code>sqrt(x)</code>, <code>log(x)</code></p>

  <input id="funcion" placeholder="Ej: x^2 - 4" />
  <button onclick="graficar()">Graficar</button>

  <div id="output"></div>
  <div id="grafico" style="width: 100%; height: 500px;"></div>

  <script>
    function graficar() {
      const input = document.getElementById("funcion").value;
      const output = document.getElementById("output");
      let expr;

      try {
        expr = math.parse(input);
        var f = expr.compile();
      } catch {
        output.innerHTML = "‚ùå Error: funci√≥n no v√°lida.";
        hablar("Error. La funci√≥n no es v√°lida.");
        return;
      }

      // 1. Analizar dominio exacto
      let exclusiones = analizarDominio(expr);
      const dominioTexto = exclusiones.length > 0
        ? `Todos los reales excepto x = ${exclusiones.join(", ")}`
        : "Todos los reales ‚Ñù";

      // 2. Evaluar puntos para graficar y encontrar asintotas verticales
      let xValues = [], yValues = [], asintotasV = [];

      for (let i = -100; i <= 100; i += 0.5) {
        let scope = { x: i };
        try {
          let y = f.evaluate(scope);
          if (!isFinite(y)) {
            yValues.push(null);
            asintotasV.push(i.toFixed(2));
          } else {
            yValues.push(y);
          }
        } catch {
          yValues.push(null);
          asintotasV.push(i.toFixed(2));
        }
        xValues.push(i);
      }

      let yFiltrado = yValues.filter(v => v !== null && isFinite(v));
      let minY = Math.min(...yFiltrado);
      let maxY = Math.max(...yFiltrado);
      let rangoTexto = `Desde aproximadamente ${minY.toFixed(2)} hasta ${maxY.toFixed(2)}`;

      // 3. Estimar as√≠ntotas horizontales (l√≠mites)
      const limPos = estimarLimite(f, 1e6);
      const limNeg = estimarLimite(f, -1e6);

      let shapes = [];

      // As√≠ntotas verticales
      let asintotasUnicas = [...new Set(asintotasV)];
      shapes.push(...asintotasUnicas.map(x0 => ({
        type: 'line',
        x0: parseFloat(x0), x1: parseFloat(x0),
        y0: -100, y1: 100,
        line: { color: 'red', width: 1.5, dash: 'dot' }
      })));

      // As√≠ntotas horizontales
      let asintotasH = [];
      if (isFinite(limPos)) {
        shapes.push({
          type: 'line',
          x0: -100, x1: 100,
          y0: limPos, y1: limPos,
          line: { color: 'green', width: 1.5, dash: 'dashdot' }
        });
        asintotasH.push(limPos.toFixed(2));
      }
      if (isFinite(limNeg) && limNeg !== limPos) {
        shapes.push({
          type: 'line',
          x0: -100, x1: 100,
          y0: limNeg, y1: limNeg,
          line: { color: 'green', width: 1.5, dash: 'dashdot' }
        });
        asintotasH.push(limNeg.toFixed(2));
      }

      // 4. Gr√°fico con Plotly
      const trace = {
        x: xValues,
        y: yValues,
        mode: 'lines',
        name: 'f(x)',
        line: { color: 'blue' }
      };

      Plotly.newPlot('grafico', [trace], {
        title: `Gr√°fico de f(x) = ${input}`,
        xaxis: { title: 'x' },
        yaxis: { title: 'f(x)', range: [-20, 20] },
        shapes: shapes
      });

      // 5. Mostrar resultados
      const resultadoHTML = `
        ‚úÖ <b>Dominio:</b> ${dominioTexto}<br>
        üìà <b>Rango:</b> ${rangoTexto}<br>
        üî∫ <b>As√≠ntotas verticales:</b> ${asintotasUnicas.length > 0 ? asintotasUnicas.join(", ") : "Ninguna"}<br>
        üîª <b>As√≠ntotas horizontales:</b> ${asintotasH.length > 0 ? asintotasH.join(", ") : "Ninguna"}
      `;
      output.innerHTML = resultadoHTML;

      // 6. Bot de voz
      let textoVoz = `El dominio es: ${dominioTexto}. El rango es de ${minY.toFixed(2)} a ${maxY.toFixed(2)}.`;
      if (asintotasUnicas.length > 0) textoVoz += ` As√≠ntotas verticales en x igual a ${asintotasUnicas.join(", ")}.`;
      if (asintotasH.length > 0) textoVoz += ` As√≠ntotas horizontales en y igual a ${asintotasH.join(", ")}.`;
      hablar(textoVoz);
    }

    function estimarLimite(f, xValor) {
      try {
        return f.evaluate({ x: xValor });
      } catch {
        return NaN;
      }
    }

    function analizarDominio(expr) {
      let exclusiones = [];

      expr.traverse(function (node) {
        if (node.type === 'OperatorNode' && node.op === '/') {
          try {
            let den = node.args[1];
            let fDen = den.compile();
            for (let i = -100; i <= 100; i += 0.5) {
              let val = fDen.evaluate({ x: i });
              if (Math.abs(val) < 0.0001) exclusiones.push(i.toFixed(2));
            }
          } catch {}
        }
        if (node.type === 'FunctionNode') {
          const fn = node.fn.name;
          let arg = node.args[0];
          let fArg = arg.compile();
          for (let i = -100; i <= 100; i += 0.5) {
            try {
              let val = fArg.evaluate({ x: i });
              if ((fn === 'sqrt' && val < 0) || (fn === 'log' && val <= 0)) {
                exclusiones.push(i.toFixed(2));
              }
            } catch {}
          }
        }
      });

      return [...new Set(exclusiones)];
    }

    function hablar(texto) {
      const speech = new SpeechSynthesisUtterance();
      speech.lang = "es-ES";
      speech.text = texto;
      window.speechSynthesis.speak(speech);
    }
  </script>

</body>
</html>
