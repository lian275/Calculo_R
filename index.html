<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Funciones Cuadráticas y Lineales</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 30px;
    }
    input, button {
      padding: 10px;
      margin: 10px;
      width: 320px;
    }
    #output {
      margin-top: 20px;
      font-size: 18px;
    }
  </style>
</head>
<body>

  <h2>📈 Funciones Cuadráticas y Lineales</h2>
  <p>Ejemplos: <code>x^2 - 4x + 3</code>, <code>2x + 5</code></p>

  <input id="funcion" placeholder="Ej: x^2 - 4x + 3 o 2x + 5" />
  <button onclick="resolver()">Resolver</button>

  <div id="output"></div>
  <div id="grafico" style="width: 100%; height: 500px;"></div>

  <script>
    function resolver() {
      const input = document.getElementById("funcion").value;
      const output = document.getElementById("output");
      let expr;

      try {
        expr = math.parse(input);
        var f = expr.compile();
      } catch {
        output.innerHTML = "❌ Función no válida.";
        hablar("Error. La función ingresada no es válida.");
        return;
      }

      const polinomio = math.simplify(input);
      const grado = math.degree(polinomio, 'x');

      let tipo = "", dominioTexto = "Todos los reales ℝ", rangoTexto = "";
      let infoExtra = "", textoVoz = "";
      let asintotasH = [], shapes = [];

      if (grado === 1) {
        tipo = "lineal";
        rangoTexto = "Todos los reales ℝ";
        infoExtra = "Tipo de función: lineal.";
      } else if (grado === 2) {
        tipo = "cuadrática";
        // Extraer coeficientes a, b, c
        const coefs = math.simplify(input).coefficients();
        let a = coefs[0] || 0;
        let b = coefs[1] || 0;
        let c = coefs[2] || 0;

        const verticeX = -b / (2 * a);
        const verticeY = a * verticeX ** 2 + b * verticeX + c;
        rangoTexto = a > 0
          ? `Desde ${verticeY.toFixed(2)} hasta ∞`
          : `Desde -∞ hasta ${verticeY.toFixed(2)}`;

        infoExtra = `Tipo de función: cuadrática. Vértice: (${verticeX.toFixed(2)}, ${verticeY.toFixed(2)})`;
      } else {
        output.innerHTML = "Solo se permiten funciones lineales o cuadráticas.";
        hablar("Solo puedes ingresar funciones cuadráticas o lineales.");
        return;
      }

      // Puntos para graficar
      let xValues = [], yValues = [];
      for (let i = -50; i <= 50; i += 0.1) {
        let y = f.evaluate({ x: i });
        xValues.push(i);
        yValues.push(y);
      }

      // Asíntotas horizontales si existieran
      const limPos = estimarLimite(f, 1e6);
      const limNeg = estimarLimite(f, -1e6);

      if (isFinite(limPos)) {
        shapes.push({
          type: 'line',
          x0: -100, x1: 100,
          y0: limPos, y1: limPos,
          line: { color: 'green', width: 1.5, dash: 'dashdot' }
        });
        asintotasH.push(limPos.toFixed(2));
      }

      if (isFinite(limNeg) && limNeg !== limPos) {
        shapes.push({
          type: 'line',
          x0: -100, x1: 100,
          y0: limNeg, y1: limNeg,
          line: { color: 'green', width: 1.5, dash: 'dashdot' }
        });
        asintotasH.push(limNeg.toFixed(2));
      }

      // Gráfico con Plotly
      const trace = {
        x: xValues,
        y: yValues,
        mode: 'lines',
        name: 'f(x)',
        line: { color: 'blue' }
      };

      Plotly.newPlot('grafico', [trace], {
        title: `Gráfico de f(x) = ${input}`,
        xaxis: { title: 'x' },
        yaxis: { title: 'f(x)', range: [-20, 20] },
        shapes: shapes
      });

      // Mostrar resultados
      const resultadoHTML = `
        ✅ <b>Dominio:</b> ${dominioTexto}<br>
        📈 <b>Rango:</b> ${rangoTexto}<br>
        🔻 <b>Asíntotas horizontales:</b> ${asintotasH.length > 0 ? asintotasH.join(", ") : "Ninguna"}<br>
        ℹ️ ${infoExtra}
      `;
      output.innerHTML = resultadoHTML;

      // Texto para el bot de voz
      textoVoz = `Función ${tipo}. El dominio es: ${dominioTexto}. El rango es: ${rangoTexto}. `;
      if (asintotasH.length > 0) {
        textoVoz += `Tiene asíntotas horizontales en y igual a ${asintotasH.join(", ")}.`;
      }

      hablar(textoVoz);
    }

    function estimarLimite(f, xValor) {
      try {
        return f.evaluate({ x: xValor });
      } catch {
        return NaN;
      }
    }

    function hablar(texto) {
      const speech = new SpeechSynthesisUtterance();
      speech.lang = "es-ES";
      speech.text = texto;
      window.speechSynthesis.speak(speech);
    }
  </script>

</body>
</html>
