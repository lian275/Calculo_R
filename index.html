<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Graficador de Funciones</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f8f8f8; padding: 20px; }
    input, button { font-size: 16px; padding: 10px; margin: 5px; }
    #grafico { margin-top: 30px; }
    #bot-explica { margin-top: 20px; background: #e0f7fa; padding: 15px; border-radius: 10px; }
  </style>
</head>
<body>

<h2>üìò Graficador de Funciones Lineales, Cuadr√°ticas y Racionales</h2>
<p>Ejemplos v√°lidos: <code>2*x + 3</code> | <code>x^2 - 4</code> | <code>2 / (x - 2)</code></p>

<input type="text" id="funcion" placeholder="Ejemplo: 2 / (x - 2)" size="40">
<button onclick="graficarFuncion()">Graficar</button>
<button onclick="leerBot()">üîä Leer Explicaci√≥n</button>

<div id="resultado"></div>
<div id="grafico"></div>
<div id="bot-explica"></div>

<script>
  let ultimaExplicacion = "";

  function graficarFuncion() {
    const entrada = document.getElementById("funcion").value.trim();
    const expresion = entrada.replace(/^y\\s*=\\s*/i, '');
    const expr = math.parse(expresion);
    const compiled = expr.compile();
    const evaluar = x => {
      try {
        return compiled.evaluate({x});
      } catch {
        return NaN;
      }
    };

    const res = document.getElementById("resultado");
    const bot = document.getElementById("bot-explica");

    let tipo = "lineal";
    if (expresion.includes("x^2")) tipo = "cuadr√°tica";
    if (expresion.includes("/")) tipo = "racional";

    let dominio = "‚Ñù (todos los reales)";
    let rango = "‚Ñù";
    let asintotasV = [], asintotaH = null;
    let color = tipo === "lineal" ? "orange" : tipo === "cuadr√°tica" ? "blue" : "purple";

    try {
      if (tipo === "cuadr√°tica") {
        const f0 = evaluar(0), f1 = evaluar(1), f2 = evaluar(2);
        const a = (f2 - 2 * f1 + f0);
        const b = f1 - f0 - a;
        const xV = -b / (2 * a);
        const yV = evaluar(xV);
        rango = a > 0 ? `[${yV.toFixed(2)}, ‚àû)` : `(-‚àû, ${yV.toFixed(2)}]`;
      }

      // Detectar as√≠ntotas verticales
      for (let x = -20; x <= 20; x += 0.05) {
        const y1 = evaluar(x);
        const y2 = evaluar(x + 0.01);
        if (!isFinite(y1) || !isFinite(y2) || Math.abs(y2 - y1) > 100) {
          asintotasV.push(parseFloat(x.toFixed(2)));
        }
      }
      asintotasV = [...new Set(asintotasV)];

      // As√≠ntota horizontal (limite hacia ¬±infinito)
      if (tipo === "racional") {
        const limiteDer = evaluar(1e4);
        const limiteIzq = evaluar(-1e4);
        if (isFinite(limiteDer) && isFinite(limiteIzq) && Math.abs(limiteDer - limiteIzq) < 1) {
          asintotaH = `y = ${((limiteDer + limiteIzq)/2).toFixed(2)}`;
        }
      }

      let x_vals = [], y_vals = [], puntos = {x: [], y: []};
      for (let x = -20; x <= 20; x += 0.1) {
        const y = evaluar(x);
        if (isFinite(y)) {
          x_vals.push(x);
          y_vals.push(y);
          if (Number.isInteger(x)) {
            puntos.x.push(x);
            puntos.y.push(y);
          }
        }
      }

      const trazas = [
        {
          x: x_vals,
          y: y_vals,
          mode: 'lines',
          name: 'f(x)',
          line: { color: color }
        },
        {
          x: puntos.x,
          y: puntos.y,
          mode: 'markers',
          name: 'Puntos enteros',
          marker: { color: 'black', size: 6 }
        }
      ];

      // Dibujar as√≠ntotas verticales
      asintotasV.forEach(x => {
        trazas.push({
          x: [x, x],
          y: [-100, 100],
          mode: 'lines',
          name: `Asintota x = ${x}`,
          line: { dash: 'dash', color: 'red', width: 2 }
        });
      });

      // Dibujar as√≠ntota horizontal
      if (asintotaH) {
        const yVal = parseFloat(asintotaH.split("=")[1]);
        trazas.push({
          x: [-20, 20],
          y: [yVal, yVal],
          mode: 'lines',
          name: asintotaH,
          line: { dash: 'dot', color: 'green', width: 2 }
        });
      }

      Plotly.newPlot("grafico", trazas, {
        title: `Gr√°fica de y = ${expresion}`,
        xaxis: { title: 'x', range: [-20, 20] },
        yaxis: { title: 'y' }
      });

      res.innerHTML = `
        <p><strong>üìå Tipo:</strong> Funci√≥n ${tipo}</p>
        <p><strong>üîë Dominio:</strong> ${dominio}</p>
        <p><strong>üìà Rango:</strong> ${rango}</p>
        <p><strong>‚ÜïÔ∏è As√≠ntotas verticales:</strong> ${asintotasV.length ? asintotasV.join(', ') : 'Ninguna'}</p>
        <p><strong>‚ÜîÔ∏è As√≠ntota horizontal:</strong> ${asintotaH || 'Ninguna'}</p>
      `;

      ultimaExplicacion = `Esta es una funci√≥n ${tipo}. Su dominio es ${dominio}. El rango aproximado es ${rango}. `;
      if (asintotasV.length) ultimaExplicacion += `Tiene as√≠ntotas verticales en x = ${asintotasV.join(', ')}. `;
      if (asintotaH) ultimaExplicacion += `Tiene as√≠ntota horizontal en ${asintotaH}.`;

      bot.innerHTML = `<strong>ü§ñ Bot:</strong> ${ultimaExplicacion}`;

    } catch (err) {
      res.innerHTML = `<p style="color:red;">‚ùå Error: funci√≥n inv√°lida.</p>`;
      Plotly.purge("grafico");
      bot.innerHTML = "";
    }
  }

  function leerBot() {
    if ('speechSynthesis' in window && ultimaExplicacion) {
      const voz = new SpeechSynthesisUtterance(ultimaExplicacion);
      voz.lang = 'es-ES';
      speechSynthesis.cancel();
      speechSynthesis.speak(voz);
    } else {
      alert('Tu navegador no soporta el bot de voz.');
    }
  }
</script>

</body>
</html>
